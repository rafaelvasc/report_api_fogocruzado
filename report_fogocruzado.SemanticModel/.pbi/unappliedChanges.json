{
  "$schema": "https://developer.microsoft.com/json-schemas/fabric/item/semanticModel/unappliedChanges/1.0.0/schema.json",
  "conceptualSchemaSettings": {},
  "queries": [
    {
      "name": "Email_API_FogoCruzado",
      "queryGroupId": "fa02577a-883e-4f34-b763-cd0b2731dfda",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "\"rafael.vasconcellos@outlook.com.br\" meta [IsParameterQuery=true, Type=\"Text\", IsParameterQueryRequired=true]"
      ],
      "loadAsTableDisabled": true,
      "resultType": "Text"
    },
    {
      "name": "Senha_API_FogoCruzado",
      "queryGroupId": "fa02577a-883e-4f34-b763-cd0b2731dfda",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "\"fogocruzado\" meta [IsParameterQuery=true, Type=\"Text\", IsParameterQueryRequired=true]"
      ],
      "loadAsTableDisabled": true,
      "resultType": "Text"
    },
    {
      "name": "API_Autenticacao",
      "queryGroupId": "d1558d87-790e-4152-9b4e-50f89a182045",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    // üîê Par√¢metros (tipo Texto)",
        "    Email = Email_API_FogoCruzado,",
        "    Senha = Senha_API_FogoCruzado,",
        "    UrlLogin = UrlLogin_API_FogoCruzado,",
        "",
        "    // üß© Corpo do POST como texto JSON",
        "    BodyText = Text.FromBinary(Json.FromValue([",
        "        email = Email,",
        "        password = Senha",
        "    ])),",
        "",
        "    // üöÄ Chamada HTTP POST",
        "    Response = Web.Contents(",
        "        UrlLogin,    // ‚úÖ Aqui usa o endpoint da API",
        "        [",
        "            Headers = [",
        "                #\"Content-Type\" = \"application/json; charset=utf-8\",",
        "                #\"Accept\" = \"application/json\"",
        "            ],",
        "            Content = Text.ToBinary(BodyText)",
        "        ]",
        "    ),",
        "",
        "    // üß™ Converter o retorno bin√°rio em JSON",
        "    JsonResponse = Json.Document(Response),",
        "",
        "    // üîë Extrair token",
        "    Token = JsonResponse[data][accessToken]",
        "in",
        "    Token"
      ],
      "isDirectQuery": false,
      "loadAsTableDisabled": true,
      "resultType": "Text"
    },
    {
      "name": "UrlLogin_API_FogoCruzado",
      "queryGroupId": "fa02577a-883e-4f34-b763-cd0b2731dfda",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "\"https://api-service.fogocruzado.org.br/api/v2/auth/login\" meta [IsParameterQuery=true, Type=\"Any\", IsParameterQueryRequired=true]"
      ],
      "loadAsTableDisabled": true,
      "resultType": "Text"
    },
    {
      "name": "fOcorrencias",
      "queryGroupId": "64ed5348-eec2-4c54-83a7-4ca597113568",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    Token = fnGetToken(),",
        "    BaseUrl = \"https://api-service.fogocruzado.org.br\",",
        "    IdEstado_RJ = \"b112ffbe-17b3-4ad0-8f2a-2038745d1d14\",",
        "    ItensPorPagina = 200,  // pode ser 100, 200, etc.",
        "    DataInicial = \"2016-07-01T00:00:00\",",
        "    DataFinal = \"2025-11-03T23:59:59\",",
        "",
        "    GetPage = (Pagina as number) =>",
        "        let",
        "            Endpoint =",
        "                \"api/v2/occurrences?\"",
        "                & \"idState=\" & IdEstado_RJ",
        "                & \"&initialDate=\" & DataInicial",
        "                & \"&finalDate=\" & DataFinal",
        "                & \"&order=ASC\"",
        "                & \"&page=\" & Number.ToText(Pagina)",
        "                & \"&take=\" & Number.ToText(ItensPorPagina),",
        "",
        "            Fonte = Json.Document(",
        "                Web.Contents(",
        "                    BaseUrl,",
        "                    [",
        "                        RelativePath = Endpoint,",
        "                        Headers = [",
        "                            #\"Authorization\" = \"Bearer \" & Token,",
        "                            #\"Accept\" = \"application/json\"",
        "                        ]",
        "                    ]",
        "                )",
        "            ),",
        "",
        "            Dados = Fonte[data],",
        "            Meta = Fonte[pageMeta],",
        "            ProximaPagina = if Meta[hasNextPage] then Pagina + 1 else null,",
        "",
        "            Resultado = [",
        "                PaginaAtual = Pagina,",
        "                Proxima = ProximaPagina,",
        "                Dados = Dados",
        "            ]",
        "        in",
        "            Resultado,",
        "",
        "    // üîÅ Pagina√ß√£o autom√°tica at√© acabar",
        "    TodasAsPaginas =",
        "        List.Generate(",
        "            () => [Pagina = 1, Resultado = GetPage(1)],",
        "            each [Resultado][Dados] <> null and List.Count([Resultado][Dados]) > 0,",
        "            each [",
        "                Pagina = if [Resultado][Proxima] <> null then [Resultado][Proxima] else null,",
        "                Resultado = if [Resultado][Proxima] <> null then GetPage([Resultado][Proxima]) else [Resultado]",
        "            ],",
        "            each [Resultado][Dados]",
        "        ),",
        "",
        "    ListaFinal = List.Combine(TodasAsPaginas),",
        "",
        "    Tabela = Table.FromList(ListaFinal, Splitter.SplitByNothing(), {\"Registro\"}),",
        "",
        "    Expandido = Table.ExpandRecordColumn(",
        "        Tabela, \"Registro\",",
        "        {\"id\", \"documentNumber\", \"address\", \"date\", \"state\", \"city\", \"neighborhood\", \"contextInfo\"},",
        "        {\"Id\", \"Documento\", \"Endere√ßo\", \"Data\", \"Estado\", \"Cidade\", \"Bairro\", \"Contexto\"}",
        "    ),",
        "    ExpEstado = Table.ExpandRecordColumn(Expandido, \"Estado\", {\"name\"}, {\"Estado\"}),",
        "    ExpCidade = Table.ExpandRecordColumn(ExpEstado, \"Cidade\", {\"name\"}, {\"Cidade\"}),",
        "    ExpBairro = Table.ExpandRecordColumn(ExpCidade, \"Bairro\", {\"name\"}, {\"Bairro\"}),",
        "    ExpMotivo = Table.ExpandRecordColumn(ExpBairro, \"Contexto\", {\"mainReason\"}, {\"MotivoPrincipal\"}),",
        "    ExpMotivoFinal = Table.ExpandRecordColumn(ExpMotivo, \"MotivoPrincipal\", {\"name\"}, {\"Motivo\"}),",
        "    #\"Tipo Alterado\" = Table.TransformColumnTypes(ExpMotivoFinal,{{\"Id\", type text}, {\"Documento\", Int64.Type}, {\"Endere√ßo\", type text}, {\"Data\", type datetime}, {\"Estado\", type text}, {\"Cidade\", type text}, {\"Bairro\", type text}, {\"Motivo\", type text}}),",
        "    #\"Dividir Coluna por Delimitador\" = Table.SplitColumn(Table.TransformColumnTypes(#\"Tipo Alterado\", {{\"Data\", type text}}, \"pt-BR\"), \"Data\", Splitter.SplitTextByDelimiter(\" \", QuoteStyle.Csv), {\"Data\", \"Hora\"}),",
        "    #\"Tipo Alterado1\" = Table.TransformColumnTypes(#\"Dividir Coluna por Delimitador\",{{\"Data\", type date}, {\"Hora\", type time}})",
        "in",
        "    #\"Tipo Alterado1\""
      ],
      "isDirectQuery": false,
      "resultType": "Table"
    },
    {
      "name": "fnGetToken",
      "queryGroupId": "d1558d87-790e-4152-9b4e-50f89a182045",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    fnGetToken = () as text =>",
        "    let",
        "        Email = Email_API_FogoCruzado,",
        "        Senha = Senha_API_FogoCruzado,",
        "        BaseUrl = \"https://api-service.fogocruzado.org.br\",",
        "        Endpoint = \"api/v2/auth/login\",",
        "",
        "        BodyText = Text.FromBinary(Json.FromValue([",
        "            email = Email,",
        "            password = Senha",
        "        ])),",
        "",
        "        Response = Web.Contents(",
        "            BaseUrl,",
        "            [",
        "                RelativePath = Endpoint,",
        "                Headers = [",
        "                    #\"Content-Type\" = \"application/json; charset=utf-8\",",
        "                    #\"Accept\" = \"application/json\"",
        "                ],",
        "                Content = Text.ToBinary(BodyText)",
        "            ]",
        "        ),",
        "",
        "        JsonResponse = Json.Document(Response),",
        "        Token = JsonResponse[data][accessToken]",
        "    in",
        "        Token",
        "in",
        "    fnGetToken"
      ],
      "resultType": "Function"
    },
    {
      "name": "dEstados",
      "queryGroupId": "64ed5348-eec2-4c54-83a7-4ca597113568",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    Token = fnGetToken(),",
        "    Fonte = Json.Document(",
        "        Web.Contents(",
        "            \"https://api-service.fogocruzado.org.br/api/v2/states\",",
        "            [",
        "                Headers = [",
        "                    #\"Authorization\" = \"Bearer \" & Token,",
        "                    #\"Accept\" = \"application/json\"",
        "                ]",
        "            ]",
        "        )",
        "    ),",
        "    Estados = Fonte[data],",
        "    Tabela = Table.FromList(Estados, Splitter.SplitByNothing(), {\"Registro\"}),",
        "    Expandido = Table.ExpandRecordColumn(Tabela, \"Registro\", {\"id\", \"name\"}, {\"IdEstado\", \"Estado\"})",
        "in",
        "    Expandido"
      ],
      "isDirectQuery": false,
      "resultType": "Table"
    }
  ],
  "queryGroups": [
    {
      "name": "Parametros",
      "id": "fa02577a-883e-4f34-b763-cd0b2731dfda",
      "description": ""
    },
    {
      "name": "Token",
      "id": "d1558d87-790e-4152-9b4e-50f89a182045",
      "order": 1,
      "description": ""
    },
    {
      "name": "Fato",
      "id": "64ed5348-eec2-4c54-83a7-4ca597113568",
      "order": 2,
      "description": ""
    },
    {
      "name": "Dimens√µes",
      "id": "23025a39-d5b2-44c4-96a8-772766811c4e",
      "order": 3,
      "description": ""
    }
  ],
  "culture": "pt-BR"
}