{
  "$schema": "https://developer.microsoft.com/json-schemas/fabric/item/semanticModel/unappliedChanges/1.0.0/schema.json",
  "conceptualSchemaSettings": {},
  "queries": [
    {
      "name": "Email_API_FogoCruzado",
      "lineageTag": "a39a02d2-d93e-4076-81c8-77dd5278828a",
      "queryGroupId": "fa02577a-883e-4f34-b763-cd0b2731dfda",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "\"rafael.vasconcellos@outlook.com.br\" meta [IsParameterQuery=true, Type=\"Text\", IsParameterQueryRequired=true]"
      ],
      "loadAsTableDisabled": true,
      "resultType": "Text"
    },
    {
      "name": "Senha_API_FogoCruzado",
      "lineageTag": "b969499f-e493-434c-b586-1c7e1c2253fa",
      "queryGroupId": "fa02577a-883e-4f34-b763-cd0b2731dfda",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "\"fogocruzado\" meta [IsParameterQuery=true, Type=\"Text\", IsParameterQueryRequired=true]"
      ],
      "loadAsTableDisabled": true,
      "resultType": "Text"
    },
    {
      "name": "API_Autenticacao",
      "lineageTag": "cd1deb19-e0fa-496a-8fa1-b92a3cf21168",
      "queryGroupId": "d1558d87-790e-4152-9b4e-50f89a182045",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    // üîê Par√¢metros",
        "    Email = Email_API_FogoCruzado,",
        "    Senha = Senha_API_FogoCruzado,",
        "    UrlLogin = UrlLogin_API_FogoCruzado,",
        "",
        "    // üß© Corpo do POST em JSON",
        "    BodyText = Text.FromBinary(Json.FromValue([",
        "        email = Email,",
        "        password = Senha",
        "    ])),",
        "",
        "    // üöÄ Requisi√ß√£o com tratamento de erro",
        "    TokenResult = try",
        "        let",
        "            Response = Web.Contents(",
        "                UrlLogin,",
        "                [",
        "                    Headers = [",
        "                        #\"Content-Type\" = \"application/json; charset=utf-8\",",
        "                        #\"Accept\" = \"application/json\"",
        "                    ],",
        "                    Content = Text.ToBinary(BodyText)",
        "                ]",
        "            ),",
        "            JsonResponse = Json.Document(Response),",
        "            Token = JsonResponse[data][accessToken]",
        "        in",
        "            Token",
        "    otherwise",
        "        // Retorno em caso de erro",
        "        error \"Erro ao autenticar. Verifique o e-mail, senha, ou a URL de login.\"",
        "in",
        "    TokenResult"
      ],
      "isDirectQuery": false,
      "loadAsTableDisabled": true,
      "resultType": "Text"
    },
    {
      "name": "UrlLogin_API_FogoCruzado",
      "lineageTag": "e62ed154-5ad5-4ac7-ab08-37e08eb003fe",
      "queryGroupId": "fa02577a-883e-4f34-b763-cd0b2731dfda",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "\"https://api-service.fogocruzado.org.br/api/v2/auth/login\" meta [IsParameterQuery=true, Type=\"Any\", IsParameterQueryRequired=true]"
      ],
      "loadAsTableDisabled": true,
      "resultType": "Text"
    },
    {
      "name": "fOcorrencias",
      "lineageTag": "a3a1b150-8df9-403e-a1a7-a61b19737976",
      "queryGroupId": "64ed5348-eec2-4c54-83a7-4ca597113568",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    // Token da fun√ß√£o de autentica√ß√£o",
        "    Token = fnGetToken(),",
        "",
        "    // Configura√ß√£o base da API",
        "    BaseUrl = \"https://api-service.fogocruzado.org.br\",",
        "    IdEstado_RJ = \"b112ffbe-17b3-4ad0-8f2a-2038745d1d14\",",
        "    ItensPorPagina = 200,",
        "",
        "    // Fun√ß√£o que retorna uma p√°gina da API com seus dados",
        "    GetPage = (Pagina as number) =>",
        "        let",
        "            Endpoint =",
        "                \"api/v2/occurrences?\"",
        "                & \"idState=\" & IdEstado_RJ",
        "                & \"&order=ASC\"",
        "                & \"&page=\" & Number.ToText(Pagina)",
        "                & \"&take=\" & Number.ToText(ItensPorPagina),",
        "",
        "            Fonte = Json.Document(",
        "                Web.Contents(",
        "                    BaseUrl,",
        "                    [",
        "                        RelativePath = Endpoint,",
        "                        Headers = [",
        "                            #\"Authorization\" = \"Bearer \" & Token,",
        "                            #\"Accept\" = \"application/json\"",
        "                        ]",
        "                    ]",
        "                )",
        "            ),",
        "",
        "            Dados = Fonte[data],",
        "            Meta = Fonte[pageMeta],",
        "            ProximaPagina = if Meta[hasNextPage] then Pagina + 1 else null",
        "        in",
        "            [Dados = Dados, Proxima = ProximaPagina],",
        "",
        "    // Pagina√ß√£o din√¢mica: carrega at√© acabar os dados",
        "    TodasAsPaginas =",
        "        List.Generate(",
        "            () => GetPage(1),",
        "            each [Dados] <> null and List.Count([Dados]) > 0,",
        "            each if [Proxima] <> null then GetPage([Proxima]) else [Dados = {}, Proxima = null],",
        "            each [Dados]",
        "        ),",
        "",
        "    // Combina todas as p√°ginas em uma √∫nica lista",
        "    ListaFinal = List.Combine(TodasAsPaginas),",
        "",
        "    // Converte lista em tabela",
        "    Tabela = Table.FromList(ListaFinal, Splitter.SplitByNothing(), {\"Registro\"}),",
        "",
        "    // Expande os campos principais da ocorr√™ncia",
        "    Expandido = Table.ExpandRecordColumn(",
        "        Tabela, \"Registro\",",
        "        {\"id\", \"documentNumber\", \"address\", \"date\", \"state\", \"city\", \"neighborhood\", \"contextInfo\", \"latitude\", \"longitude\", \"policeAction\", \"agentPresence\"},",
        "        {\"Id\", \"Documento\", \"Endereco\", \"DataHora\", \"Estado\", \"Cidade\", \"Bairro\", \"Contexto\", \"Latitude\", \"Longitude\", \"AcaoPolicial\", \"PresencaAgente\"}",
        "    ),",
        "",
        "    ExpEstado = Table.ExpandRecordColumn(Expandido, \"Estado\", {\"name\"}, {\"Estado\"}),",
        "    ExpCidade = Table.ExpandRecordColumn(ExpEstado, \"Cidade\", {\"name\"}, {\"Cidade\"}),",
        "    ExpBairro = Table.ExpandRecordColumn(ExpCidade, \"Bairro\", {\"name\"}, {\"Bairro\"}),",
        "    ExpMotivo = Table.ExpandRecordColumn(ExpBairro, \"Contexto\", {\"mainReason\"}, {\"MotivoPrincipal\"}),",
        "    ExpMotivoFinal = Table.ExpandRecordColumn(ExpMotivo, \"MotivoPrincipal\", {\"name\"}, {\"Motivo\"}),",
        "",
        "    // Convers√£o de tipos com tratamento de campos nulos",
        "    Tipos = Table.TransformColumnTypes(ExpMotivoFinal, {",
        "        {\"Id\", type text},",
        "        {\"Documento\", Int64.Type},",
        "        {\"Endereco\", type text},",
        "        {\"DataHora\", type datetime},",
        "        {\"Estado\", type text},",
        "        {\"Cidade\", type text},",
        "        {\"Bairro\", type text},",
        "        {\"Motivo\", type text},",
        "        {\"Latitude\", type nullable text},",
        "        {\"Longitude\", type nullable text},",
        "        {\"AcaoPolicial\", type nullable logical},",
        "        {\"PresencaAgente\", type nullable logical}",
        "    }),",
        "",
        "    // Separa√ß√£o de data e hora",
        "    DataHoraTexto = Table.TransformColumnTypes(Tipos, {{\"DataHora\", type text}}, \"pt-BR\"),",
        "    Dividido = Table.SplitColumn(DataHoraTexto, \"DataHora\", Splitter.SplitTextByDelimiter(\" \", QuoteStyle.Csv), {\"Data\", \"Hora\"}),",
        "",
        "    // Tipagem final",
        "    TiposFinais = Table.TransformColumnTypes(Dividido, {",
        "        {\"Data\", type date},",
        "        {\"Hora\", type time}",
        "    })",
        "in",
        "    TiposFinais"
      ],
      "isDirectQuery": false,
      "resultType": "Table"
    },
    {
      "name": "fnGetToken",
      "lineageTag": "5d4bdf13-800b-4aeb-ae96-9e2744a88b88",
      "queryGroupId": "d1558d87-790e-4152-9b4e-50f89a182045",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    fnGetToken = () as text =>",
        "    let",
        "        // üîê Par√¢metros",
        "        Email = Email_API_FogoCruzado,",
        "        Senha = Senha_API_FogoCruzado,",
        "        BaseUrl = \"https://api-service.fogocruzado.org.br\",",
        "        Endpoint = \"api/v2/auth/login\",",
        "",
        "        // üß© Montar corpo do POST",
        "        BodyText = Text.FromBinary(Json.FromValue([",
        "            email = Email,",
        "            password = Senha",
        "        ])),",
        "",
        "        // üöÄ Fazer requisi√ß√£o com tratamento de erro",
        "        Token = try",
        "            let",
        "                Response = Web.Contents(",
        "                    BaseUrl,",
        "                    [",
        "                        RelativePath = Endpoint,",
        "                        Headers = [",
        "                            #\"Content-Type\" = \"application/json; charset=utf-8\",",
        "                            #\"Accept\" = \"application/json\"",
        "                        ],",
        "                        Content = Text.ToBinary(BodyText)",
        "                    ]",
        "                ),",
        "                JsonResponse = Json.Document(Response),",
        "                AccessToken = JsonResponse[data][accessToken]",
        "            in",
        "                AccessToken",
        "        otherwise",
        "            error \"‚ùå Erro ao obter o token. Verifique as credenciais ou a URL da API.\"",
        "    in",
        "        Token",
        "in",
        "    fnGetToken"
      ],
      "resultType": "Function"
    },
    {
      "name": "dCidades",
      "queryGroupId": "23025a39-d5b2-44c4-96a8-772766811c4e",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    Token = fnGetToken(),",
        "    BaseUrl = \"https://api-service.fogocruzado.org.br\",",
        "    Endpoint = \"api/v2/cities\",",
        "    Fonte = Json.Document(",
        "        Web.Contents(BaseUrl,",
        "            [",
        "                RelativePath = Endpoint,",
        "                Headers = [",
        "                    #\"Authorization\" = \"Bearer \" & Token,",
        "                    #\"Accept\" = \"application/json\"",
        "                ]",
        "            ]",
        "        )",
        "    ),",
        "    Dados = Fonte[data],",
        "    Tabela = Table.FromList(Dados, Splitter.SplitByNothing(), {\"Registro\"}),",
        "    CidadesExpandidas = Table.ExpandRecordColumn(Tabela, \"Registro\", {\"id\", \"name\", \"state\"}, {\"IdCidade\", \"NomeCidade\", \"Estado\"}),",
        "    EstadoExp = Table.ExpandRecordColumn(CidadesExpandidas, \"Estado\", {\"id\", \"name\"}, {\"IdEstado\", \"NomeEstado\"})",
        "in",
        "    EstadoExp"
      ],
      "isDirectQuery": false,
      "resultType": "Table"
    },
    {
      "name": "dEstados",
      "lineageTag": "1608da20-9b92-4671-8d9a-a88f6e6eb9b3",
      "queryGroupId": "23025a39-d5b2-44c4-96a8-772766811c4e",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    Token = fnGetToken(),",
        "    BaseUrl = \"https://api-service.fogocruzado.org.br\",",
        "    Endpoint = \"api/v2/states\",",
        "    Fonte = Json.Document(",
        "        Web.Contents(BaseUrl,",
        "            [",
        "                RelativePath = Endpoint,",
        "                Headers = [",
        "                    #\"Authorization\" = \"Bearer \" & Token,",
        "                    #\"Accept\" = \"application/json\"",
        "                ]",
        "            ]",
        "        )",
        "    ),",
        "    Dados = Fonte[data],",
        "    Tabela = Table.FromList(Dados, Splitter.SplitByNothing(), {\"Registro\"}),",
        "    Estados = Table.ExpandRecordColumn(Tabela, \"Registro\", {\"id\", \"name\"}, {\"IdEstado\", \"NomeEstado\"})",
        "in",
        "    Estados"
      ],
      "isDirectQuery": false,
      "resultType": "Table"
    },
    {
      "name": "dMotivos",
      "queryGroupId": "23025a39-d5b2-44c4-96a8-772766811c4e",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    // Tabela de ocorr√™ncias j√° carregada (por exemplo, chamada fOcorrencias)",
        "    Base = fOcorrencias, // troque pelo nome da sua query de ocorr√™ncias",
        "    Motivos = Table.Distinct(",
        "        Table.SelectColumns(fOcorrencias, {\"Motivo\"})",
        "    )",
        "in",
        "    Motivos"
      ],
      "isDirectQuery": false,
      "resultType": "Table"
    },
    {
      "name": "fPerfilVitimas",
      "queryGroupId": "64ed5348-eec2-4c54-83a7-4ca597113568",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    Token = fnGetToken(),",
        "    BaseUrl = \"https://api-service.fogocruzado.org.br\",",
        "    IdEstado_RJ = \"b112ffbe-17b3-4ad0-8f2a-2038745d1d14\",",
        "    ItensPorPagina = 200,",
        "    DataInicial = \"2023-01-01T00:00:00\",",
        "    DataFinal = \"2025-11-03T23:59:59\",",
        "",
        "    // Fun√ß√£o que busca uma p√°gina",
        "    GetPage = (Pagina as number) =>",
        "        let",
        "            Endpoint =",
        "                \"api/v2/occurrences?\"",
        "                & \"idState=\" & IdEstado_RJ",
        "                & \"&initialDate=\" & DataInicial",
        "                & \"&finalDate=\" & DataFinal",
        "                & \"&order=ASC\"",
        "                & \"&page=\" & Number.ToText(Pagina)",
        "                & \"&take=\" & Number.ToText(ItensPorPagina),",
        "",
        "            Fonte = Json.Document(",
        "                Web.Contents(",
        "                    BaseUrl,",
        "                    [",
        "                        RelativePath = Endpoint,",
        "                        Headers = [",
        "                            #\"Authorization\" = \"Bearer \" & Token,",
        "                            #\"Accept\" = \"application/json\"",
        "                        ]",
        "                    ]",
        "                )",
        "            ),",
        "            Dados = Fonte[data],",
        "            Meta = Fonte[pageMeta],",
        "            Proxima = if Meta[hasNextPage] then Pagina + 1 else null",
        "        in",
        "            [Dados = Dados, Proxima = Proxima],",
        "",
        "    TodasPaginas = List.Generate(",
        "        () => GetPage(1),",
        "        each [Dados] <> null and List.Count([Dados]) > 0,",
        "        each if [Proxima] <> null then GetPage([Proxima]) else [Dados = {}, Proxima = null],",
        "        each [Dados]",
        "    ),",
        "",
        "    Ocorrencias = List.Combine(TodasPaginas),",
        "",
        "    // Extraindo v√≠timas humanas (flatten)",
        "    TodasVitimas = List.Combine(",
        "        List.Transform(Ocorrencias, each ",
        "            let",
        "                IdOcorrencia = _[id],",
        "                Vits = try _[victims] otherwise {}",
        "            in",
        "                List.Transform(Vits, each Record.AddField(_, \"idOcorrencia\", IdOcorrencia))",
        "        )",
        "    ),",
        "",
        "    TabelaVitimas = Table.FromList(TodasVitimas, Splitter.SplitByNothing(), {\"Vitima\"}),",
        "    Expandido = Table.ExpandRecordColumn(TabelaVitimas, \"Vitima\", {",
        "        \"idOcorrencia\", \"situation\", \"personType\", \"age\", \"ageGroup\", \"genre\"",
        "    }, {",
        "        \"OcorrenciaId\", \"Situacao\", \"TipoPessoa\", \"Idade\", \"FaixaEtaria\", \"Genero\"",
        "    }),",
        "",
        "    ExpFaixa = Table.ExpandRecordColumn(Expandido, \"FaixaEtaria\", {\"name\"}, {\"FaixaEtaria\"}),",
        "    ExpGenero = Table.ExpandRecordColumn(ExpFaixa, \"Genero\", {\"name\"}, {\"Genero\"}),",
        "",
        "    Tipos = Table.TransformColumnTypes(ExpGenero, {",
        "        {\"OcorrenciaId\", type text},",
        "        {\"Situacao\", type text},",
        "        {\"TipoPessoa\", type text},",
        "        {\"Idade\", Int64.Type},",
        "        {\"FaixaEtaria\", type text},",
        "        {\"Genero\", type text}",
        "    })",
        "in",
        "    Tipos"
      ],
      "resultType": "Table"
    },
    {
      "name": "dFaixaEtaria",
      "queryGroupId": "23025a39-d5b2-44c4-96a8-772766811c4e",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    Fonte = Table.Distinct(",
        "        Table.SelectColumns(fPerfilVitimas, {\"FaixaEtaria\"})",
        "    )",
        "in",
        "    Fonte"
      ],
      "resultType": "Table"
    },
    {
      "name": "dSituacao",
      "queryGroupId": "23025a39-d5b2-44c4-96a8-772766811c4e",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    Fonte = Table.Distinct(",
        "        Table.SelectColumns(fPerfilVitimas, {\"Situacao\"})",
        "    ),",
        "    #\"Personaliza√ß√£o Adicionada\" = Table.AddColumn(Fonte, \"Situacao_ptbr\", each if [Situacao] = \"Dead\" then \"Morto\"",
        "else if [Situacao] = \"Wounded\" then \"Ferido\"",
        "else \"N√£o identificado\", type text)",
        "in",
        "    #\"Personaliza√ß√£o Adicionada\""
      ],
      "resultType": "Table"
    },
    {
      "name": "dTipoPessoas",
      "queryGroupId": "23025a39-d5b2-44c4-96a8-772766811c4e",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    Fonte = Table.Distinct(",
        "        Table.SelectColumns(fPerfilVitimas, {\"TipoPessoa\"})",
        "    ),",
        "    #\"Personaliza√ß√£o Adicionada\" = Table.AddColumn(Fonte, \"TipoPessoa_ptbr\", each if [TipoPessoa]= \"Agent\" then \"Agente P√∫blico\"",
        "else if [TipoPessoa]=\"Civilian\" then \"Civil\"",
        "else \"N√£o Identificado\", type text)",
        "in",
        "    #\"Personaliza√ß√£o Adicionada\""
      ],
      "resultType": "Table"
    }
  ],
  "queryGroups": [
    {
      "name": "Parametros",
      "id": "fa02577a-883e-4f34-b763-cd0b2731dfda",
      "description": ""
    },
    {
      "name": "Token",
      "id": "d1558d87-790e-4152-9b4e-50f89a182045",
      "order": 1,
      "description": ""
    },
    {
      "name": "Fato",
      "id": "64ed5348-eec2-4c54-83a7-4ca597113568",
      "order": 2,
      "description": ""
    },
    {
      "name": "Dimens√µes",
      "id": "23025a39-d5b2-44c4-96a8-772766811c4e",
      "order": 3,
      "description": ""
    }
  ],
  "culture": "pt-BR",
  "firewallEnabled": true
}