{
  "$schema": "https://developer.microsoft.com/json-schemas/fabric/item/semanticModel/unappliedChanges/1.0.0/schema.json",
  "conceptualSchemaSettings": {},
  "queries": [
    {
      "name": "Email_API_FogoCruzado",
      "queryGroupId": "fa02577a-883e-4f34-b763-cd0b2731dfda",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "\"rafael.vasconcellos@outlook.com.br\" meta [IsParameterQuery=true, Type=\"Text\", IsParameterQueryRequired=true]"
      ],
      "loadAsTableDisabled": true,
      "resultType": "Text"
    },
    {
      "name": "Senha_API_FogoCruzado",
      "queryGroupId": "fa02577a-883e-4f34-b763-cd0b2731dfda",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "\"33518497aA!\" meta [IsParameterQuery=true, Type=\"Text\", IsParameterQueryRequired=true]"
      ],
      "loadAsTableDisabled": true,
      "resultType": "Text"
    },
    {
      "name": "API_Autenticacao",
      "queryGroupId": "d1558d87-790e-4152-9b4e-50f89a182045",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    // üîê Par√¢metros (tipo Texto)",
        "    Email = Email_API_FogoCruzado,",
        "    Senha = Senha_API_FogoCruzado,",
        "    UrlLogin = UrlLogin_API_FogoCruzado,",
        "",
        "    // üß© Corpo do POST como texto JSON",
        "    BodyText = Text.FromBinary(Json.FromValue([",
        "        email = Email,",
        "        password = Senha",
        "    ])),",
        "",
        "    // üöÄ Chamada HTTP POST",
        "    Response = Web.Contents(",
        "        UrlLogin,    // ‚úÖ Aqui usa o endpoint da API",
        "        [",
        "            Headers = [",
        "                #\"Content-Type\" = \"application/json; charset=utf-8\",",
        "                #\"Accept\" = \"application/json\"",
        "            ],",
        "            Content = Text.ToBinary(BodyText)",
        "        ]",
        "    ),",
        "",
        "    // üß™ Converter o retorno bin√°rio em JSON",
        "    JsonResponse = Json.Document(Response),",
        "",
        "    // üîë Extrair token",
        "    Token = JsonResponse[data][accessToken]",
        "in",
        "    Token"
      ],
      "resultType": "Text"
    },
    {
      "name": "UrlLogin_API_FogoCruzado",
      "queryGroupId": "fa02577a-883e-4f34-b763-cd0b2731dfda",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "\"https://api-service.fogocruzado.org.br/api/v2/auth/login\" meta [IsParameterQuery=true, Type=\"Any\", IsParameterQueryRequired=true]"
      ],
      "loadAsTableDisabled": true,
      "resultType": "Text"
    },
    {
      "name": "fOcorrencias",
      "queryGroupId": "64ed5348-eec2-4c54-83a7-4ca597113568",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    // üîë Token obtido da fun√ß√£o de autentica√ß√£o",
        "    Token = fnGetToken(),",
        "",
        "    // üåç Base URL da API",
        "    BaseUrl = \"https://api-service.fogocruzado.org.br\",",
        "",
        "    // ‚öôÔ∏è Par√¢metros",
        "    IdEstado_RJ = \"b111ffbe-17b3-4ad0-8f2a-2038745d1d13\",",
        "    ItensPorPagina = 100,",
        "    DataInicial = \"2016-07-01\",",
        "    DataFinal = Date.ToText(Date.From(DateTime.LocalNow())),",
        "",
        "    // üîÅ Fun√ß√£o para buscar uma p√°gina da API",
        "    GetPage = (Pagina as number) =>",
        "        let",
        "            Endpoint =",
        "                \"api/v2/occurrences?\"",
        "                & \"order=ASC\"",
        "                & \"&page=\" & Number.ToText(Pagina)",
        "                & \"&take=\" & Number.ToText(ItensPorPagina)",
        "                & \"&initialDate=\" & DataInicial",
        "                & \"&finalDate=\" & DataFinal",
        "                & \"&idState=\" & IdEstado_RJ,",
        "",
        "            Fonte = try Json.Document(",
        "                Web.Contents(",
        "                    BaseUrl,",
        "                    [",
        "                        RelativePath = Endpoint,",
        "                        Headers = [",
        "                            #\"Authorization\" = \"Bearer \" & Token,",
        "                            #\"Accept\" = \"application/json\"",
        "                        ],",
        "                        ManualStatusHandling = {400,401,403}",
        "                    ]",
        "                )",
        "            ) otherwise null,",
        "",
        "            Dados = if Fonte <> null and Record.HasFields(Fonte, \"data\") then Fonte[data] else {},",
        "            Meta = if Fonte <> null and Record.HasFields(Fonte, \"pageMeta\") then Fonte[pageMeta] else null,",
        "            ProximaPagina =",
        "                if Meta <> null and Record.HasFields(Meta, \"hasNextPage\") and Meta[hasNextPage]",
        "                then Pagina + 1",
        "                else null,",
        "",
        "            Resultado = [",
        "                PaginaAtual = Pagina,",
        "                Proxima = ProximaPagina,",
        "                Dados = Dados",
        "            ]",
        "        in",
        "            Resultado,",
        "",
        "    // üîÑ Pagina√ß√£o com List.Generate",
        "    TodasAsPaginas =",
        "        List.Generate(",
        "            () => [Pagina = 1, Resultado = GetPage(1)],",
        "            each [Resultado][Dados] <> null and List.Count([Resultado][Dados]) > 0,",
        "            each [",
        "                Pagina = if [Resultado][Proxima] <> null then [Resultado][Proxima] else null,",
        "                Resultado = if [Resultado][Proxima] <> null then GetPage([Resultado][Proxima]) else [Resultado]",
        "            ],",
        "            each [Resultado][Dados]",
        "        ),",
        "",
        "    // üß± Combina todas as p√°ginas (gera uma lista √∫nica de registros)",
        "    ListaFinal = List.Combine(TodasAsPaginas),",
        "",
        "    // ‚úÖ Garante que a lista seja uma tabela com uma coluna padronizada",
        "    Tabela = ",
        "        if List.Count(ListaFinal) > 0 ",
        "        then Table.FromList(ListaFinal, Splitter.SplitByNothing(), {\"Registro\"})",
        "        else #table({\"Registro\"}, {}),",
        "",
        "    // üß© Expande campos principais",
        "    Expandido = Table.ExpandRecordColumn(",
        "        Tabela,",
        "        \"Registro\",",
        "        {\"id\", \"documentNumber\", \"address\", \"date\", \"state\", \"city\", \"neighborhood\", \"contextInfo\"},",
        "        {\"Id\", \"Documento\", \"Endere√ßo\", \"Data\", \"Estado\", \"Cidade\", \"Bairro\", \"Contexto\"}",
        "    ),",
        "",
        "    ExpEstado = Table.ExpandRecordColumn(Expandido, \"Estado\", {\"name\"}, {\"Estado\"}),",
        "    ExpCidade = Table.ExpandRecordColumn(ExpEstado, \"Cidade\", {\"name\"}, {\"Cidade\"}),",
        "    ExpBairro = Table.ExpandRecordColumn(ExpCidade, \"Bairro\", {\"name\"}, {\"Bairro\"}),",
        "    ExpMotivo = Table.ExpandRecordColumn(ExpBairro, \"Contexto\", {\"mainReason\"}, {\"MotivoPrincipal\"}),",
        "    ExpMotivoFinal = Table.ExpandRecordColumn(ExpMotivo, \"MotivoPrincipal\", {\"name\"}, {\"Motivo\"})",
        "in",
        "    ExpMotivoFinal"
      ],
      "resultType": "Table"
    },
    {
      "name": "fnGetToken",
      "queryGroupId": "d1558d87-790e-4152-9b4e-50f89a182045",
      "navigationStepName": "Navega√ß√£o",
      "text": [
        "let",
        "    fnGetToken = () as text =>",
        "    let",
        "        Email = Email_API_FogoCruzado,",
        "        Senha = Senha_API_FogoCruzado,",
        "        BaseUrl = \"https://api-service.fogocruzado.org.br\",",
        "        Endpoint = \"api/v2/auth/login\",",
        "",
        "        BodyText = Text.FromBinary(Json.FromValue([",
        "            email = Email,",
        "            password = Senha",
        "        ])),",
        "",
        "        Response = Web.Contents(",
        "            BaseUrl,",
        "            [",
        "                RelativePath = Endpoint,",
        "                Headers = [",
        "                    #\"Content-Type\" = \"application/json; charset=utf-8\",",
        "                    #\"Accept\" = \"application/json\"",
        "                ],",
        "                Content = Text.ToBinary(BodyText)",
        "            ]",
        "        ),",
        "",
        "        JsonResponse = Json.Document(Response),",
        "        Token = JsonResponse[data][accessToken]",
        "    in",
        "        Token",
        "in",
        "    fnGetToken"
      ],
      "resultType": "Function"
    }
  ],
  "queryGroups": [
    {
      "name": "Parametros",
      "id": "fa02577a-883e-4f34-b763-cd0b2731dfda",
      "description": ""
    },
    {
      "name": "Token",
      "id": "d1558d87-790e-4152-9b4e-50f89a182045",
      "order": 1,
      "description": ""
    },
    {
      "name": "Fato",
      "id": "64ed5348-eec2-4c54-83a7-4ca597113568",
      "order": 2,
      "description": ""
    },
    {
      "name": "Dimens√µes",
      "id": "23025a39-d5b2-44c4-96a8-772766811c4e",
      "order": 3,
      "description": ""
    }
  ],
  "culture": "pt-BR"
}